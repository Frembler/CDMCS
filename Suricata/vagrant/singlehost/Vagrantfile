$provision_script = <<SCRIPT
start=$(date)

cat >> /etc/sysctl.conf <<EOF
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
EOF
sysctl -p

echo 'Acquire::ForceIPv4 "true";' | sudo tee /etc/apt/apt.conf.d/99force-ipv4
export DEBIAN_FRONTEND=noninteractive


#set versions here

ELASTICSEARCH="elasticsearch-5.2.1.deb"
EVEBOX="evebox_0.6.0dev~dev20170223182129_amd64.deb"

cd /vagrant

# starting with elasticsearch because its start takes time ...
echo "$(date) installing openjdk-8-jdk-headless"
apt-get -y install openjdk-8-jdk-headless > /dev/null 2>&1
echo "$(date) installing Elasticsearch"
[[ -f $ELASTICSEARCH ]] || wget  -q -4 https://artifacts.elastic.co/downloads/elasticsearch/$ELASTICSEARCH
dpkg -i $ELASTICSEARCH > /dev/null 2>&1
systemctl enable elasticsearch
systemctl start elasticsearch


#suricata
echo "$(date) installing Suricata"
add-apt-repository ppa:oisf/suricata-stable > /dev/null 2>&1
apt-get update > /dev/null 2>&1
apt-get -y install suricata > /dev/null 2>&1
systemctl stop suricata

#ls /sys/class/net | grep -v lo
# see http://pevma.blogspot.com.ee/2015/05/suricata-multiple-interface.html
cat >> /etc/suricata/suricata.yaml <<EOF
af-packet:
  - interface: enp0s3
    cluster-id: 98
    cluster-type: cluster_flow
    defrag: yes
  - interface: enp0s8
    cluster-id: 97
    cluster-type: cluster_flow
    defrag: yes
EOF
touch  /etc/suricata//threshold.config
#suricata -T -vvv
[[ $(suricata -T) ]] || exit -1

# evebox
echo "$(date) installing GeoLite2"
[[ -f 'GeoLite2-City.mmdb.gz' ]] || wget -q  -4 http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.mmdb.gz
mkdir -p /usr/local/share/GeoIP
gunzip GeoLite2-City.mmdb.gz --stdout > /usr/local/share/GeoIP/GeoLite2-City.mmdb
echo "$(date) installing evebox"
[[ -f $EVEBOX ]] ||wget  -q -4 https://bintray.com/jasonish/evebox-development-debian/download_file?file_path=$EVEBOX -O $EVEBOX
dpkg -i $EVEBOX > /dev/null 2>&1

echo 'ELASTICSEARCH_INDEX="evebox"' >> /etc/default/evebox
cp /etc/default/evebox /etc/default/evebox-esimport

#create template
export ELASTICSEARCH_INDEX="evebox"
evebox esimport --verbose --oneshot --elasticsearch http://localhost:9200 /var/log/suricata/eve.json

cat > /lib/systemd/system/evebox-esimport.service <<EOF
[Unit]
Description=EveBox-EsImport

[Service]
ExecStart=/usr/bin/evebox esimport \\$ELASTICSEARCH_URL \\$CONFIG \\$EVEBOX_OPTS --end /var/log/suricata/eve.json
EnvironmentFile=-/etc/default/evebox-esimport

[Install]
WantedBy=multi-user.target
EOF

systemctl enable evebox-esimport
systemctl start evebox-esimport

systemctl enable evebox
systemctl start evebox



echo "DONE :: start $start end $(date)"
SCRIPT


Vagrant.configure(2) do |config|
  config.vm.define 'Amstelredamme' do |box|
      box.vm.box = "ubuntu/xenial64"
      box.vm.hostname = 'Amstelredamme'
      box.vm.network :private_network, ip: "192.168.10.11"
      box.vm.provider :virtualbox do |vb|
       vb.customize ["modifyvm", :id, "--memory", "4096"]
       vb.customize ["modifyvm", :id, "--cpus", "4"]
      end
      config.vm.provision "shell", inline: $provision_script
  end
end
